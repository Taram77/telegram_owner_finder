# Telegram Owner Finder Bot

Этот проект представляет собой систему Telegram-ботов для автоматического мониторинга каналов, выявления объявлений о продаже недвижимости от собственников и уведомления администратора.

## Архитектура

Проект построен на микросервисной архитектуре с использованием Docker Compose для развертывания.
Основные компоненты:

*   **PostgreSQL**: Основная база данных для хранения конфигурации, информации о каналах, аккаунтах userbot-ов, обработанных сообщениях и лидах.
*   **Redis**: Используется для быстрого кэширования, дедупликации, управления состоянием диалогов и механизмов rate-limiting.
*   **RabbitMQ**: Брокер сообщений для асинхронного взаимодействия между микросервисами, обеспечивая надежную передачу задач и событий.
*   **Admin Bot (`aiogram`)**: Telegram-бот, через который администратор управляет настройками системы (добавление/удаление каналов, изменение приветственного сообщения, просмотр лидов). Также получает уведомления о найденных собственниках.
*   **Userbot Core (`Pyrogram`)**: Основной сервис, отвечающий за мониторинг Telegram-каналов (от имени пользовательских аккаунтов), фильтрацию объявлений, инициирование личных сообщений потенциальным собственникам. Он управляет пулом userbot-аккаунтов для соблюдения лимитов Telegram.
*   **Processing Service (Python)**: Обрабатывает ответы от пользователей в личных сообщениях, определяет, является ли отвечающий собственником или агентом, фиксирует результат в БД и передает информацию в Admin Bot при обнаружении собственника.

## Требования

*   Docker
*   Docker Compose
*   Ubuntu Server (или любая другая Linux-система с Docker)

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/your-username/telegram_owner_finder.git
    cd telegram_owner_finder
    ```

2.  **Настройте переменные окружения:**
    Создайте файл `.env` в корневой директории проекта (`telegram_owner_finder/`) и заполните его, используя `.env.example` как шаблон.
    **Особое внимание уделите:**
    *   `TELEGRAM_BOT_TOKEN`: Получите токен у BotFather для вашего Admin Bot.
    *   `ADMIN_USER_ID`: Ваш числовой Telegram User ID (можно узнать через @userinfobot).
    *   `PYROGRAM_API_ID` и `PYROGRAM_API_HASH`: Получите эти данные, зарегистрировав приложение на [my.telegram.org/apps](https://my.telegram.org/apps).

3.  **Сгенерируйте сессии Userbot-ов:**
    Для работы Userbot Core требуется как минимум один аккаунт Telegram, работающий от имени пользователя. Для этого:
    *   Убедитесь, что `PYROGRAM_API_ID` и `PYROGRAM_API_HASH` прописаны в вашем `.env` файле.
    *   Запустите вспомогательный скрипт **локально** (не в Docker контейнере):
        ```bash
        cd userbot_core/src
        pip install -r ../requirements.txt # Установите зависимости Pyrogram
        python session_generator.py
        ```
    *   Следуйте инструкциям скрипта (введите номер телефона, код подтверждения, 2FA-пароль при необходимости).
    *   После успешного выполнения вы получите `session_string`. **Сохраните его.**
    *   **Добавьте этот аккаунт в базу данных.** Пока что это нужно сделать вручную:
        Подключитесь к PostgreSQL (например, через `psql -h localhost -U user -d telegram_owner_finder`) и выполните команду:
        ```sql
        INSERT INTO user_accounts (phone_number, session_string) VALUES ('+ВВВВВВВВВВВ', 'ВАША_SESSION_STRING') ON CONFLICT (phone_number) DO UPDATE SET session_string = EXCLUDED.session_string, is_active = TRUE;
        ```
        Замените `+ВВВВВВВВВВВ` на ваш номер телефона, а `ВАША_SESSION_STRING` на полученную строку.

4.  **Запустите проект с помощью Docker Compose:**
    Из корневой директории проекта (`telegram_owner_finder/`):
    ```bash
    docker-compose up --build -d
    ```
    *   `--build`: Пересобирает образы Docker. Используйте при первом запуске или изменении кода/Dockerfile.
    *   `-d`: Запускает контейнеры в фоновом режиме.

5.  **Проверьте статус контейнеров:**
    ```bash
    docker-compose ps
    ```
    Все сервисы должны быть в статусе `Up`.

## Использование Admin Bot

1.  Найдите ваш Admin Bot в Telegram (по имени, которое вы дали при получении токена).
2.  Отправьте `/start`.
3.  Используйте команды:
    *   `/add_channel <ID канала>`: Добавить канал для мониторинга (например, `-1001234567890`).
    *   `/list_channels`: Просмотреть активные каналы.
    *   `/set_welcome_message <новый текст>`: Изменить сообщение, которое бот отправляет в DM.
    *   `/list_leads`: Просмотреть список найденных собственников.

## Важные аспекты и следующие шаги

*   **Защита от блокировок:** Текущая реализация включает базовый rate-limiting и использование нескольких аккаунтов. Однако, для реального продакшена необходимы более сложные стратегии:
    *   Ротация IP-адресов (использование прокси для userbot-ов).
    *   "Человеческое" поведение (случайные задержки, имитация просмотра каналов).
    *   Мониторинг статуса аккаунтов (проверка на блокировки).
    *   Автоматическая обработка ошибок API (например, `FLOOD_WAIT`).
*   **Обработка ошибок и логирование:** В шаблоне базовое логирование. Для продакшена нужна централизованная система логирования (например, ELK stack или Grafana Loki).
*   **Улучшение парсинга ответов:** `dialog_manager.py` использует простые ключевые слова. Можно использовать более продвинутые методы NLP для точного определения статуса "собственник/агент".
*   **Масштабирование:** Docker Compose подходит для одного сервера. Для горизонтального масштабирования (несколько серверов) стоит рассмотреть Kubernetes.
*   **Безопасность:** Регулярное обновление зависимостей, защита API-ключей, изоляция сетей Docker.
*   **Администрирование аккаунтов userbot-ов:** Добавьте в Admin Bot функции для добавления/удаления/активации/деактивации userbot-аккаунтов, чтобы не делать это вручную через БД.
*   **Дедупликация:** Текущий механизм использует хеш текста. Это хорошо, но могут быть объявления с небольшими изменениями. Можно улучшить, например, сравнивая близкие по содержанию объявления.
*   **UI/UX для администратора:** Рассмотрите возможность использования Telegram Web Apps (TWA) для более продвинутого и интерактивного административного интерфейса.
*   **Persistent Storage:** Убедитесь, что вы используете Docker volumes для баз данных, чтобы данные сохранялись при перезапуске контейнеров. В нашем `docker-compose.yml` это уже настроено.
